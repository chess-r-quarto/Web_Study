<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FP1級 法人税別表マスター（Matrix Edition）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        lichess: {
                            dark: { bg: '#161512', panel: '#262421', hover: '#363431', border: '#403d39', text: '#dbd7d1', textMuted: '#b9b5b0' },
                            light: { bg: '#eeeed2', panel: '#ffffff', hover: '#f5f5f5', border: '#d3d3d3', text: '#222222', textMuted: '#555555' },
                            green: { 500: '#629924', 600: '#53821f', text: '#ffffff' },
                            red: { 500: '#c33', 600: '#a22', text: '#ffffff' }
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans JP', 'sans-serif'],
                        mono: ['Consolas', 'Monaco', 'monospace'],
                    }
                }
            }
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
        Babel.registerPreset('tsx', { 
            presets: [
                [Babel.availablePresets['typescript'], { isTSX: true, allExtensions: true }], 
                Babel.availablePresets['react']
            ] 
        });
    </script>

    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom Scrollbar for Lichess aesthetic */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        html.dark ::-webkit-scrollbar-thumb {
            background: #403d39;
        }
        .animate-fade-in {
            animation: fadeIn 0.2s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-lichess-light-bg text-lichess-light-text dark:bg-lichess-dark-bg dark:text-lichess-dark-text transition-colors duration-200">
    <div id="root"></div>

    <script type="text/babel" data-presets="tsx">
        const { useState, useEffect, useMemo } = React;

        // --- 0. 型定義 ---
        interface MatrixItem {
            cat: string;
            num: string;
            name: string;
            point: string;
        }

        interface QuizItem {
            formNum: string;
            formName: string;
            question: string;
            options: string[];
            answer: number;
            note: string;
        }

        type ScreenType = 'start' | 'quiz' | 'result' | 'reference';

        // --- 1. データ ---
        const matrixData: MatrixItem[] = [
            { cat: "計算の出口", num: "一（一）", name: "普通法人申告書", point: "税額計算の最終結果。中小法人の軽減税率（15%）の適用。" },
            { cat: "属性判定", num: "二", name: "同族会社等の判定", point: "重要。同族会社・特定同族会社の判定。私的自治への制限の端緒。" },
            { cat: "所得調整", num: "四", name: "所得の金額の計算", point: "最重要。確定決算主義と税務固有の調整（加算・減算）。" },
            { cat: "資産管理", num: "五（一）", name: "利益積立金・資本金等", point: "税務上のB/S。純資産の推移。自己株式の取得等の資本取引も含む。" },
            { cat: "租税公課", num: "五（二）", name: "租税公課の納付状況", point: "損金不算入となる法人税・住民税と、損金算入される事業税の峻別。" },
            { cat: "欠損金", num: "七（一）", name: "欠損金の損金算入", point: "欠損金の繰越控除。事業承継や企業再生における「担税力」の調整。" },
            { cat: "二重課税", num: "八（一）", name: "受取配当の益金不算入", point: "法人を通じた配当に対する二重課税の排除ロジック。" },
            { cat: "引当金", num: "十一", name: "貸倒引当金", point: "中小法人等に認められる法定繰入率等の特例実務。" },
            { cat: "社会的費用", num: "十四（二）", name: "寄附金の損金算入", point: "損金算入限度額の計算。公益への寄与と租税回避の境界。" },
            { cat: "政策減税", num: "十五", name: "交際費等の損金算入", point: "飲食費50%不算入と800万円定額控除の有利選択（実務頻出）。" },
            { cat: "償却実務", num: "十六", name: "減価償却資産の計算", point: "16(7)の中小特例（30万円未満）を含む。課税の時期繰延べ機能。" }
        ];

        const quizData: QuizItem[] = [
            { formNum: "別表一（一）", formName: "各事業年度の所得に係る申告書", question: "別表一（一）の「所得金額」欄には、どの別表の金額が転記されるか？", options: ["別表四の総額", "別表五（一）の期末残高"], answer: 0, note: "別表四で確定した所得金額が、別表一（一）へ転記され、そこで税率が乗じられます。" },
            { formNum: "別表一（一）", formName: "各事業年度の所得に係る申告書", question: "中小法人の年800万円以下の所得に対する「軽減税率（15%）」の適用計算を行う場所は？", options: ["別表一（一）", "別表四"], answer: 0, note: "税額計算そのものは別表一（一）の機能です。別表四はあくまで所得の算出までです。" },
            { formNum: "別表一（一）", formName: "各事業年度の所得に係る申告書", question: "同族会社の「留保金課税」の税額を加算して最終納付税額を出す別表は？", options: ["別表一（一）", "別表三（一）"], answer: 0, note: "計算明細は別表三（一）ですが、最終的に法人税額として合算・申告するのは別表一（一）です。" },
            { formNum: "別表二", formName: "同族会社等の判定に関する明細書", question: "同族会社の判定において、上位何位までの株主グループで50%超を保有しているかを確認するか？", options: ["第3順位まで", "第5順位まで"], answer: 0, note: "上位3グループで発行済株式等の50%超を保有する場合、同族会社と判定されます。" },
            { formNum: "別表二", formName: "同族会社等の判定に関する明細書", question: "留保金課税の対象となる「特定同族会社」の判定を行う別表は？", options: ["別表二", "別表一"], answer: 0, note: "別表二で株主構成を確認し、特定同族会社の該当性もここでチェックします。" },
            { formNum: "別表二", formName: "同族会社等の判定に関する明細書", question: "同族会社の判定を行う時期（基準時）はいつか？", options: ["事業年度終了の時", "株主総会の時"], answer: 0, note: "原則として、その事業年度終了の現況により判定します。" },
            { formNum: "別表四", formName: "所得の金額の計算に関する明細書", question: "別表四で「加算・留保」とされた項目は、税務上のB/Sである別表五（一）においてどう処理される？", options: ["利益積立金額の増加となる", "利益積立金額の減少となる"], answer: 0, note: "加算・留保は「社内に残っている利益」とみなされ、別表五（一）の利益積立金を増加させます。" },
            { formNum: "別表四", formName: "所得の金額の計算に関する明細書", question: "「役員給与の損金不算入額」のように、社外にお金が出ていったが損金にならないものはどう区分される？", options: ["加算・社外流出", "加算・留保"], answer: 0, note: "お金は出ていっているので、会社内に留保されません。よって別表五（一）には蓄積されません。" },
            { formNum: "別表四", formName: "所得の金額の計算に関する明細書", question: "前期に否認された「減価償却超過額」が当期に認容（損金算入）される場合の処理は？", options: ["減算・留保", "減算・社外流出"], answer: 0, note: "過去の留保項目を取り崩すため「減算・留保」となります。別表五（一）の積立金を減らします。" },
            { formNum: "別表五（一）", formName: "利益積立金額及び資本金等の額の計算に関する明細書", question: "別表五（一）のⅠの部は主に何を表しているか？", options: ["利益積立金額（税務上の繰越利益剰余金等）", "資本金等の額（税務上の資本金等）"], answer: 0, note: "Ⅰの部が利益積立金額、Ⅱの部が資本金等の額です。税務上の純資産の部を構成します。" },
            { formNum: "別表五（一）", formName: "利益積立金額及び資本金等の額の計算に関する明細書", question: "「未納法人税等」として、確定申告で納付すべき税額を計上する場所は？", options: ["別表五（一）", "別表五（二）"], answer: 0, note: "別表五（一）の下部（利益積立金額の計算内）で、未納法人税等を減算して翌期首残高を出します。" },
            { formNum: "別表五（一）", formName: "利益積立金額及び資本金等の額の計算に関する明細書", question: "無償増資を行った場合、別表五（一）の「資本金等の額」は変動するか？", options: ["変動しない", "増加する"], answer: 0, note: "会計上の資本金は増えますが、税務上の「資本金等の額」は株主からの払込がない限り原則変動しません。" },
            { formNum: "別表五（二）", formName: "租税公課の納付状況等に関する明細書", question: "損金算入が認められる「事業税」や「事業所税」の具体的な納付状況を記載する別表は？", options: ["別表五（二）", "別表六"], answer: 0, note: "別表五（二）で納付状況を整理し、損金算入額を確定させて別表四へ転記します。" },
            { formNum: "別表五（二）", formName: "租税公課の納付状況等に関する明細書", question: "別表五（二）で計算された「当期の法人税額」は、別表四でどう処理される？", options: ["加算・社外流出（損金不算入）", "減算・留保"], answer: 0, note: "法人税は損金になりません。会計上で費用処理されていれば、別表四で加算（否認）します。" },
            { formNum: "別表五（二）", formName: "租税公課の納付状況等に関する明細書", question: "期中に支払った「中間申告分の法人税」はどこに記載する？", options: ["別表五（二）", "別表一（一）"], answer: 0, note: "まず別表五（二）で支払実績と損金不算入を整理します。" },
            { formNum: "別表七（一）", formName: "欠損金又は災害損失金の控除に関する明細書", question: "青色欠損金の繰越期間は、令和時代の現在、何年か？", options: ["10年", "9年"], answer: 0, note: "平成30年4月1日以後開始事業年度から発生した欠損金は「10年」繰越可能です。" },
            { formNum: "別表七（一）", formName: "欠損金又は災害損失金の控除に関する明細書", question: "中小法人等（資本金1億円以下等）の欠損金控除限度額は？", options: ["所得金額の100%", "所得金額の50%"], answer: 0, note: "中小法人は所得の100%まで控除可能。大法人は50%制限があります。" },
            { formNum: "別表七（一）", formName: "欠損金又は災害損失金の控除に関する明細書", question: "「欠損金の繰戻し還付」を受ける場合、別表七（一）の記入は必要か？", options: ["必要（残額管理のため）", "不要"], answer: 0, note: "還付を受けきれなかった残額を翌期に繰り越す場合など、計算の連続性のために重要です。" },
            { formNum: "別表八（一）", formName: "受取配当等の益金不算入に関する明細書", question: "完全子法人株式（持株比率100%）からの配当の益金不算入割合は？", options: ["100%（全額不算入）", "50%"], answer: 0, note: "完全グループ内の資金移動とみなされ、二重課税排除のため全額益金不算入となります。" },
            { formNum: "別表八（一）", formName: "受取配当等の益金不算入に関する明細書", question: "関連法人株式等（1/3超保有）からの配当について、控除が必要なものは？", options: ["負債の利子", "役員給与"], answer: 0, note: "配当を得るために借入金を用いたとみなされる分（負債利子）は、益金不算入額から控除します。" },
            { formNum: "別表八（一）", formName: "受取配当等の益金不算入に関する明細書", question: "非支配目的株式等（持株比率5%以下）の益金不算入割合は？", options: ["20%", "40%"], answer: 0, note: "令和4年度改正により、5%以下の保有区分は20%の益金不算入となりました。" },
            { formNum: "別表十一", formName: "貸倒引当金の損金算入に関する明細書", question: "中小法人等にのみ認められる、貸倒引当金の計算方法は？", options: ["法定繰入率による計算", "過去3年の実績率のみ"], answer: 0, note: "資本金1億円以下の中小法人は、実質的に貸倒れがなくても法定繰入率を使って損金算入できます。" },
            { formNum: "別表十一", formName: "貸倒引当金の損金算入に関する明細書", question: "一括評価金銭債権に係る貸倒引当金の計算を行うのは？", options: ["別表十一（一の二）", "別表十一（一）"], answer: 0, note: "十一（一）は個別評価、十一（一の二）が一括評価です。" },
            { formNum: "別表十一", formName: "貸倒引当金の損金算入に関する明細書", question: "別表十一で計算した貸倒引当金繰入超過額は、別表四でどう処理する？", options: ["加算・留保", "加算・社外流出"], answer: 0, note: "引当金否認は社内留保となるため「加算・留保」です。" },
            { formNum: "別表十四（二）", formName: "寄附金の損金算入に関する明細書", question: "「完全支配関係」がある法人間の寄附金の取り扱いは？", options: ["全額損金不算入", "限度額まで損金算入"], answer: 0, note: "グループ内での恣意的な利益移転を防ぐため、全額損金不算入（受贈側も全額益金不算入）となります。" },
            { formNum: "別表十四（二）", formName: "寄附金の損金算入に関する明細書", question: "国や地方公共団体に対する寄附金（国等に対する寄附金）の限度額は？", options: ["全額損金算入", "所得の2.5%まで"], answer: 0, note: "公益性が極めて高いため、全額損金算入されます。" },
            { formNum: "別表十四（二）", formName: "寄附金の損金算入に関する明細書", question: "一般の寄附金の損金算入限度額の計算基準は？", options: ["資本金等の額と所得金額", "売上高と従業員数"], answer: 0, note: "資本基準と所得基準の合計の1/4（または1/2）などで計算します。" },
            { formNum: "別表十五", formName: "交際費等の損金算入に関する明細書", question: "中小法人が選択できる交際費の定額控除限度額は？", options: ["年800万円", "年600万円"], answer: 0, note: "年800万円までの交際費を全額損金算入できる特例があります。" },
            { formNum: "別表十五", formName: "交際費等の損金算入に関する明細書", question: "交際費等のうち、全額損金不算入となる「使途秘匿金」の支出に対するペナルティ税率は？", options: ["40%の追加課税", "20%の追加課税"], answer: 0, note: "通常の法人税に加え、40%が別途課税されます。FP1級の実務知識。" },
            { formNum: "別表十五", formName: "交際費等の損金算入に関する明細書", question: "1人あたり5,000円（令和6年度改正で1万円）以下の飲食費の取り扱いは？", options: ["交際費等から除外（全額損金）", "交際費等に含める"], answer: 0, note: "所定の要件を満たせば「会議費」等として全額損金となり、別表十五の計算から除外できます。" },
            { formNum: "別表十六", formName: "減価償却資産の償却額の計算に関する明細書", question: "中小企業者等の少額減価償却資産の特例（30万円未満）を適用するための別表は？", options: ["別表十六（七）", "別表十六（一）"], answer: 0, note: "即時償却の特例適用には、別表十六（七）の添付が必要です。" },
            { formNum: "別表十六", formName: "減価償却資産の償却額の計算に関する明細書", question: "償却超過額（会社計上＞税務限度）が出た場合の処理は？", options: ["別表四で加算・留保", "別表四で減算・留保"], answer: 0, note: "限度額を超えた分は否認され、別表四で加算・留保し、翌期以降に認容を待ちます。" },
            { formNum: "別表十六", formName: "減価償却資産の償却額の計算に関する明細書", question: "一括償却資産（20万円未満）の償却期間は？", options: ["3年均等", "5年均等"], answer: 0, note: "3年間で均等償却します。別表十六（八）を使用します。" }
        ];

        // --- 2. コンポーネント ---
        const App: React.FC = () => {
            const [theme, setTheme] = useState<'dark' | 'light'>('dark');
            const [screen, setScreen] = useState<ScreenType>('start');
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [shuffledQuestions, setShuffledQuestions] = useState<QuizItem[]>([]);

            // テーマ適用
            useEffect(() => {
                const root = window.document.documentElement;
                if (theme === 'dark') {
                    root.classList.add('dark');
                } else {
                    root.classList.remove('dark');
                }
            }, [theme]);

            const toggleTheme = () => setTheme(prev => prev === 'dark' ? 'light' : 'dark');

            const startQuiz = () => {
                setShuffledQuestions([...quizData].sort(() => Math.random() - 0.5));
                setCurrentQuestionIndex(0);
                setScore(0);
                setScreen('quiz');
            };

            const navigateTo = (newScreen: ScreenType) => {
                if (screen === 'quiz' && newScreen === 'start') {
                    if (!confirm("現在の進行状況は失われます。トップに戻りますか？")) return;
                }
                setScreen(newScreen);
            };

            return (
                <div className="min-h-screen flex flex-col items-center">
                    {/* Header (Lichess style) */}
                    <header className="w-full flex items-center justify-between px-4 py-2 bg-lichess-light-panel dark:bg-lichess-dark-panel border-b border-lichess-light-border dark:border-lichess-dark-border shadow-sm">
                        <div className="flex items-center space-x-2">
                            <svg className="w-6 h-6 text-lichess-green-500" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2L2 7l10 5 10-5-10-5zm0 7.5l-10-5v2.5l10 5 10-5V9.5l-10 5zm0 5l-10-5v2.5l10 5 10-5V14.5l-10 5zm0 5l-10-5v2.5l10 5 10-5V19.5l-10 5z"/>
                            </svg>
                            <span className="font-bold tracking-tight text-lg">Tax Matrix</span>
                        </div>
                        <button 
                            onClick={toggleTheme} 
                            className="p-2 rounded hover:bg-lichess-light-hover dark:hover:bg-lichess-dark-hover transition-colors"
                            aria-label="Toggle Theme"
                        >
                            {theme === 'dark' ? (
                                <svg className="w-5 h-5 text-lichess-dark-textMuted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                            ) : (
                                <svg className="w-5 h-5 text-lichess-light-textMuted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                            )}
                        </button>
                    </header>

                    {/* Main Content Area */}
                    <main className="flex-1 w-full max-w-3xl p-4 sm:p-6 flex flex-col mt-4">
                        <div className="bg-lichess-light-panel dark:bg-lichess-dark-panel rounded shadow-sm border border-lichess-light-border dark:border-lichess-dark-border min-h-[500px] flex flex-col relative overflow-hidden">
                            {screen === 'start' && <StartScreen onStart={startQuiz} onRef={() => navigateTo('reference')} />}
                            {screen === 'reference' && <ReferenceScreen onBack={() => navigateTo('start')} onStart={startQuiz} />}
                            {screen === 'quiz' && (
                                <QuizScreen 
                                    q={shuffledQuestions[currentQuestionIndex]} 
                                    index={currentQuestionIndex} 
                                    total={shuffledQuestions.length}
                                    onAnswer={(isCorrect) => {
                                        if (isCorrect) setScore(s => s + 1);
                                    }}
                                    onNext={() => {
                                        if (currentQuestionIndex + 1 < shuffledQuestions.length) {
                                            setCurrentQuestionIndex(i => i + 1);
                                        } else {
                                            navigateTo('result');
                                        }
                                    }}
                                    onExit={() => navigateTo('start')}
                                />
                            )}
                            {screen === 'result' && <ResultScreen score={score} total={shuffledQuestions.length} onRetry={startQuiz} onRef={() => navigateTo('reference')} onTop={() => navigateTo('start')} />}
                        </div>
                    </main>
                </div>
            );
        };

        const StartScreen: React.FC<{ onStart: () => void, onRef: () => void }> = ({ onStart, onRef }) => (
            <div className="flex-1 flex flex-col items-center justify-center p-8 animate-fade-in text-center space-y-6">
                <div className="space-y-1">
                    <p className="text-xs font-bold tracking-widest text-lichess-light-textMuted dark:text-lichess-dark-textMuted uppercase">FP1 Grade Tax Law</p>
                    <h1 className="text-3xl sm:text-4xl font-black tracking-tight">法人税別表 Master</h1>
                    <h2 className="text-lg text-lichess-light-textMuted dark:text-lichess-dark-textMuted font-medium">Matrix Edition</h2>
                </div>
                
                <p className="text-sm leading-relaxed max-w-sm text-lichess-light-textMuted dark:text-lichess-dark-textMuted">
                    11様式 × 3問 = 全33問。<br/>
                    正式名称と機能のリンクを<br/>脳に刻み込む。
                </p>
                
                <div className="w-full max-w-xs space-y-3 pt-4">
                    <button onClick={onStart} className="w-full bg-lichess-green-500 hover:bg-lichess-green-600 text-lichess-green-text font-bold py-3 px-6 rounded shadow transition-colors text-lg tracking-wide flex justify-center items-center">
                        START QUIZ
                    </button>
                    <button onClick={onRef} className="w-full bg-lichess-light-hover dark:bg-lichess-dark-hover hover:bg-lichess-light-border dark:hover:bg-lichess-dark-border text-lichess-light-text dark:text-lichess-dark-text font-bold py-3 px-6 rounded transition-colors text-sm">
                        REFERENCE
                    </button>
                </div>
            </div>
        );

        const ReferenceScreen: React.FC<{ onBack: () => void, onStart: () => void }> = ({ onBack, onStart }) => (
            <div className="flex-1 flex flex-col p-4 sm:p-6 animate-fade-in h-full">
                <div className="flex justify-between items-center mb-4 pb-2 border-b border-lichess-light-border dark:border-lichess-dark-border">
                    <h2 className="text-xl font-bold">重点別表Matrix</h2>
                    <button onClick={onBack} className="text-sm font-bold text-lichess-light-textMuted dark:text-lichess-dark-textMuted hover:text-lichess-light-text dark:hover:text-lichess-dark-text transition-colors">BACK</button>
                </div>
                
                <div className="flex-1 overflow-auto rounded border border-lichess-light-border dark:border-lichess-dark-border bg-lichess-light-bg dark:bg-lichess-dark-bg">
                    <table className="w-full text-left border-collapse text-sm">
                        <thead>
                            <tr className="bg-lichess-light-panel dark:bg-lichess-dark-panel border-b border-lichess-light-border dark:border-lichess-dark-border text-xs uppercase tracking-wider text-lichess-light-textMuted dark:text-lichess-dark-textMuted">
                                <th className="p-3 font-medium whitespace-nowrap">区分</th>
                                <th className="p-3 font-medium whitespace-nowrap text-center">No.</th>
                                <th className="p-3 font-medium whitespace-nowrap">名称</th>
                                <th className="p-3 font-medium">FP1級・実務のポイント</th>
                            </tr>
                        </thead>
                        <tbody>
                            {matrixData.map((d, i) => (
                                <tr key={i} className="border-b border-lichess-light-border dark:border-lichess-dark-border hover:bg-lichess-light-hover dark:hover:bg-lichess-dark-hover transition-colors">
                                    <td className="p-3 text-xs text-lichess-light-textMuted dark:text-lichess-dark-textMuted font-mono whitespace-nowrap">{d.cat}</td>
                                    <td className="p-3 font-bold font-mono whitespace-nowrap text-center text-lichess-green-600 dark:text-lichess-green-500">{d.num}</td>
                                    <td className="p-3 font-bold whitespace-nowrap">{d.name}</td>
                                    <td className="p-3 text-xs leading-relaxed min-w-[200px]">{d.point}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
                
                <div className="mt-4 flex justify-center">
                    <button onClick={onStart} className="w-full max-w-xs bg-lichess-green-500 hover:bg-lichess-green-600 text-lichess-green-text font-bold py-2 px-4 rounded shadow transition-colors">
                        START QUIZ FROM HERE
                    </button>
                </div>
            </div>
        );

        const QuizScreen: React.FC<{ q: QuizItem, index: number, total: number, onAnswer: (correct: boolean) => void, onNext: () => void, onExit: () => void }> = ({ q, index, total, onAnswer, onNext, onExit }) => {
            const [feedback, setFeedback] = useState<{ selected: number | null, isCorrect: boolean } | null>(null);
            
            // 選択肢のシャッフル（問題が変わるたびに実行）
            const shuffledOptions = useMemo(() => {
                const opts = [{ text: q.options[0], originalIndex: 0 }, { text: q.options[1], originalIndex: 1 }];
                return opts.sort(() => Math.random() - 0.5);
            }, [q]);

            const progress = ((index) / total) * 100;

            const handleOptionClick = (originalIndex: number) => {
                if (feedback) return; // 二重クリック防止
                const isCorrect = originalIndex === q.answer;
                setFeedback({ selected: originalIndex, isCorrect });
                onAnswer(isCorrect);
            };

            const handleNext = () => {
                setFeedback(null);
                onNext();
            };

            return (
                <div className="flex-1 flex flex-col p-6 animate-fade-in relative">
                    <div className="flex justify-between items-start mb-6 border-b border-lichess-light-border dark:border-lichess-dark-border pb-4">
                        <div>
                            <div className="text-xs font-mono font-bold text-lichess-green-600 dark:text-lichess-green-500 mb-1 tracking-widest uppercase">{q.formNum}</div>
                            <div className="text-sm font-bold">{q.formName}</div>
                        </div>
                        <button onClick={onExit} className="text-xs font-bold text-lichess-light-textMuted dark:text-lichess-dark-textMuted hover:text-lichess-light-text dark:hover:text-lichess-dark-text transition-colors shrink-0 ml-4">
                            EXIT
                        </button>
                    </div>

                    {!feedback ? (
                        <div className="flex-1 flex flex-col justify-center animate-fade-in">
                            <h2 className="text-lg sm:text-xl font-bold leading-relaxed mb-8">
                                {q.question}
                            </h2>
                            <div className="space-y-3">
                                {shuffledOptions.map((opt, i) => (
                                    <button 
                                        key={i}
                                        onClick={() => handleOptionClick(opt.originalIndex)} 
                                        className="w-full text-left bg-lichess-light-bg dark:bg-lichess-dark-bg border border-lichess-light-border dark:border-lichess-dark-border hover:bg-lichess-light-hover dark:hover:bg-lichess-dark-hover p-4 rounded font-bold transition-colors flex justify-between items-center group"
                                    >
                                        <span>{opt.text}</span>
                                        <span className="opacity-0 group-hover:opacity-100 transition-opacity text-lichess-green-600 dark:text-lichess-green-500">→</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    ) : (
                        <div className="flex-1 flex flex-col justify-center animate-fade-in space-y-6">
                            <div className="text-center">
                                <div className={`text-3xl font-bold mb-2 ${feedback.isCorrect ? 'text-lichess-green-600 dark:text-lichess-green-500' : 'text-lichess-red-600 dark:text-lichess-red-500'}`}>
                                    {feedback.isCorrect ? 'Correct' : 'Incorrect'}
                                </div>
                            </div>
                            
                            <div className={`bg-lichess-light-bg dark:bg-lichess-dark-bg p-5 rounded border-l-4 shadow-sm ${feedback.isCorrect ? 'border-lichess-green-500' : 'border-lichess-red-500'} border-y border-r border-y-lichess-light-border dark:border-y-lichess-dark-border border-r-lichess-light-border dark:border-r-lichess-dark-border`}>
                                <div className="mb-2 pb-2 border-b border-lichess-light-border dark:border-lichess-dark-border">
                                    <span className="text-xs font-mono text-lichess-green-600 dark:text-lichess-green-500 mr-2">{q.formNum}</span>
                                    <span className="text-xs text-lichess-light-textMuted dark:text-lichess-dark-textMuted">{q.formName}</span>
                                </div>
                                <p className="text-xs text-lichess-light-textMuted dark:text-lichess-dark-textMuted font-bold mb-2">
                                    正解: <span className="text-lichess-light-text dark:text-lichess-dark-text">{q.options[q.answer]}</span>
                                </p>
                                <p className="text-sm font-medium leading-relaxed">
                                    {q.note}
                                </p>
                            </div>

                            <button onClick={handleNext} className="w-full bg-lichess-light-bg dark:bg-lichess-dark-bg border border-lichess-light-border dark:border-lichess-dark-border hover:bg-lichess-light-hover dark:hover:bg-lichess-dark-hover font-bold py-3 px-6 rounded transition-colors text-center mt-4">
                                NEXT
                            </button>
                        </div>
                    )}

                    <div className="mt-6">
                        <div className="w-full bg-lichess-light-bg dark:bg-lichess-dark-bg h-1 rounded overflow-hidden">
                            <div className="bg-lichess-green-500 h-1 transition-all duration-300" style={{ width: `${progress}%` }}></div>
                        </div>
                        <p className="text-right text-xs font-mono mt-2 text-lichess-light-textMuted dark:text-lichess-dark-textMuted">
                            {index + 1} / {total}
                        </p>
                    </div>
                </div>
            );
        };

        const ResultScreen: React.FC<{ score: number, total: number, onRetry: () => void, onRef: () => void, onTop: () => void }> = ({ score, total, onRetry, onRef, onTop }) => {
            const percentage = Math.round((score / total) * 100);
            let message = "";
            let colorClass = "";

            if (percentage === 100) {
                message = "Perfect. マトリックスが脳内に構築されました。";
                colorClass = "text-lichess-green-600 dark:text-lichess-green-500";
            } else if (percentage >= 90) {
                message = "Excellent. 安定した知識基盤です。";
                colorClass = "text-lichess-green-600 dark:text-lichess-green-500";
            } else if (percentage >= 70) {
                message = "Good. 苦手な様式をReferenceで復習しましょう。";
                colorClass = "text-lichess-light-text dark:text-lichess-dark-text";
            } else {
                message = "Review Required. Referenceに戻って構造を確認しましょう。";
                colorClass = "text-lichess-red-600 dark:text-lichess-red-500";
            }

            return (
                <div className="flex-1 flex flex-col items-center justify-center p-8 space-y-8 animate-fade-in">
                    <h2 className="text-2xl font-bold tracking-tight">RESULT</h2>
                    
                    <div className="text-center">
                        <div className={`text-6xl font-black mb-2 ${colorClass}`}>
                            {score} <span className="text-2xl text-lichess-light-textMuted dark:text-lichess-dark-textMuted font-medium">/ {total}</span>
                        </div>
                        <p className="text-sm font-mono tracking-widest text-lichess-light-textMuted dark:text-lichess-dark-textMuted">
                            ACCURACY: {percentage}%
                        </p>
                    </div>

                    <div className="w-full max-w-sm bg-lichess-light-bg dark:bg-lichess-dark-bg p-4 rounded border border-lichess-light-border dark:border-lichess-dark-border text-center">
                        <p className="font-bold text-sm">{message}</p>
                    </div>

                    <div className="flex flex-col w-full max-w-sm space-y-3">
                        <button onClick={onRetry} className="w-full bg-lichess-green-500 hover:bg-lichess-green-600 text-lichess-green-text font-bold py-3 px-6 rounded shadow transition-colors">
                            RETRY (Shuffle)
                        </button>
                        <button onClick={onRef} className="w-full bg-lichess-light-bg dark:bg-lichess-dark-bg border border-lichess-light-border dark:border-lichess-dark-border hover:bg-lichess-light-hover dark:hover:bg-lichess-dark-hover font-bold py-3 px-6 rounded transition-colors">
                            CHECK REFERENCE
                        </button>
                        <button onClick={onTop} className="text-sm font-bold text-lichess-light-textMuted dark:text-lichess-dark-textMuted hover:text-lichess-light-text dark:hover:text-lichess-dark-text mt-4 transition-colors">
                            BACK TO TOP
                        </button>
                    </div>
                </div>
            );
        };

        const rootElement = document.getElementById('root');
        if (rootElement) {
            const root = ReactDOM.createRoot(rootElement);
            root.render(<App />);
        }
    </script>
</body>
</html>
