<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF to Markdown (Lichess Style)</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'lichess-bg': '#161512',
            'lichess-panel': '#262421',
            'lichess-border': '#403d39',
            'lichess-text': '#dbd9d6',
            'lichess-muted': '#8c8c8c',
            'lichess-primary': '#81b64c',
            'lichess-primary-hover': '#95c560',
          },
          fontFamily: {
            sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  
  <!-- Babel Standalone -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <!-- Custom Babel Preset for TSX -->
  <script>
    Babel.registerPreset('tsx', {
      presets: [
        [Babel.availablePresets['typescript'], { isTSX: true, allExtensions: true }],
        Babel.availablePresets['react']
      ]
    });
  </script>
</head>
<body class="bg-lichess-bg text-lichess-text font-sans antialiased h-screen overflow-hidden">
  <div id="root" class="h-full"></div>

  <script type="text/babel" data-presets="tsx">
    const { useState, useRef, DragEvent, ChangeEvent } = React;

    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const extractTextFromPdf = async (file: File): Promise<string> => {
      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let markdownOutput = `# ${file.name}\n\n`;

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const textContent = await page.getTextContent();
          
          let lastY = -1;
          let pageText = '';

          for (const item of textContent.items) {
            if (lastY !== -1 && Math.abs(lastY - item.transform[5]) > 5) {
              pageText += '\n';
            } else if (lastY !== -1) {
              pageText += ' ';
            }
            pageText += item.str;
            lastY = item.transform[5];
          }

          markdownOutput += `## Page ${pageNum}\n\n${pageText}\n\n---\n\n`;
        }

        return markdownOutput;
      } catch (error) {
        console.error("PDF Extraction Error:", error);
        throw new Error("Failed to load PDF.");
      }
    };

    const App: React.FC = () => {
      const [isDragging, setIsDragging] = useState<boolean>(false);
      const [isProcessing, setIsProcessing] = useState<boolean>(false);
      const [markdown, setMarkdown] = useState<string>('');
      const [fileName, setFileName] = useState<string | null>(null);
      const fileInputRef = useRef<HTMLInputElement>(null);

      const handleDragOver = (e: DragEvent<HTMLDivElement>) => {
        e.preventDefault();
        setIsDragging(true);
      };

      const handleDragLeave = (e: DragEvent<HTMLDivElement>) => {
        e.preventDefault();
        setIsDragging(false);
      };

      const processFile = async (file: File) => {
        if (file.type !== 'application/pdf') {
          alert('Please select a PDF file.');
          return;
        }

        setIsProcessing(true);
        setFileName(file.name);
        setMarkdown('');

        try {
          const result = await extractTextFromPdf(file);
          setMarkdown(result);
        } catch (error) {
          setMarkdown(`An error occurred: ${(error as Error).message}`);
        } finally {
          setIsProcessing(false);
        }
      };

      const handleDrop = async (e: DragEvent<HTMLDivElement>) => {
        e.preventDefault();
        setIsDragging(false);
        const file = e.dataTransfer.files[0];
        if (file) {
          await processFile(file);
        }
      };

      const handleFileInput = async (e: ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (file) {
          await processFile(file);
        }
      };

      const copyToClipboard = () => {
        navigator.clipboard.writeText(markdown).catch(err => {
          console.error('Failed to copy text: ', err);
        });
      };

      const downloadMarkdown = () => {
        if (!markdown || !fileName) return;

        const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        
        const baseName = fileName.replace(/\.[^/.]+$/, "");
        link.download = `${baseName}.md`;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };

      return (
        <div className="flex flex-col h-full max-w-7xl mx-auto p-4 md:p-6 gap-6">
          <header className="flex items-center justify-between">
            <h1 className="text-2xl font-bold uppercase tracking-widest text-lichess-text flex items-center gap-3">
              <span className="text-lichess-primary">â™™</span> PDF to Markdown
            </h1>
            {fileName && (
              <div className="text-sm text-lichess-muted bg-lichess-panel px-3 py-1 rounded border border-lichess-border">
                {fileName}
              </div>
            )}
          </header>

          <main className="flex-1 flex flex-col md:flex-row gap-6 min-h-0">
            <section className="flex-1 flex flex-col min-h-0">
              <div 
                className={`flex-1 flex flex-col items-center justify-center border-2 border-dashed rounded-lg transition-colors ${isDragging ? 'border-lichess-primary bg-lichess-panel' : 'border-lichess-border bg-lichess-bg hover:bg-lichess-panel/50'} cursor-pointer`}
                onDragOver={handleDragOver}
                onDragLeave={handleDragLeave}
                onDrop={handleDrop}
                onClick={() => fileInputRef.current?.click()}
              >
                <input 
                  type="file" 
                  accept="application/pdf" 
                  className="hidden" 
                  ref={fileInputRef}
                  onChange={handleFileInput}
                />
                
                {isProcessing ? (
                  <div className="flex flex-col items-center gap-4 text-lichess-primary">
                    <svg className="animate-spin h-10 w-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span className="text-lg font-medium tracking-wide">Processing...</span>
                  </div>
                ) : (
                  <div className="flex flex-col items-center gap-2 text-lichess-muted pointer-events-none p-6 text-center">
                    <svg className="w-16 h-16 mb-4 text-lichess-border" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <p className="text-lg font-medium text-lichess-text">Drag & Drop PDF</p>
                    <p className="text-sm">or click to select file</p>
                  </div>
                )}
              </div>
            </section>

            <section className="flex-1 flex flex-col bg-lichess-panel border border-lichess-border rounded-lg overflow-hidden min-h-0 relative shadow-lg">
              <div className="flex items-center justify-between p-3 border-b border-lichess-border bg-lichess-bg/50">
                <h2 className="text-sm font-semibold text-lichess-muted uppercase tracking-wider">Markdown Output</h2>
                <div className="flex gap-2">
                  <button 
                    onClick={copyToClipboard}
                    disabled={!markdown}
                    className="bg-lichess-panel border border-lichess-border hover:bg-lichess-border disabled:opacity-50 disabled:cursor-not-allowed text-lichess-text text-xs font-bold py-1.5 px-4 rounded transition-colors shadow-sm"
                  >
                    Copy
                  </button>
                  <button 
                    onClick={downloadMarkdown}
                    disabled={!markdown}
                    className="bg-lichess-primary hover:bg-lichess-primary-hover disabled:bg-lichess-border disabled:text-lichess-muted disabled:cursor-not-allowed text-white text-xs font-bold py-1.5 px-4 rounded transition-colors shadow-sm flex items-center gap-1.5"
                  >
                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Download
                  </button>
                </div>
              </div>
              <textarea 
                className="flex-1 w-full bg-transparent text-lichess-text p-4 resize-none focus:outline-none focus:ring-1 focus:ring-lichess-primary font-mono text-sm leading-relaxed"
                value={markdown}
                readOnly
                placeholder="Markdown will appear here."
              ></textarea>
            </section>
          </main>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root') as HTMLElement);
    root.render(<App />);
  </script>
</body>
</html>
