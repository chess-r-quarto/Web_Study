<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOMC Vocabulary Quiz (Test Ver.)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts (Noto Sans JP) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #696969; /* Dim Gray */
        }
        /* スクロールバーのカスタマイズ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #696969;
        }
        ::-webkit-scrollbar-thumb {
            background: #A9A9A9;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- アイコンコンポーネント (Lucide代替) ---
        // 単一ファイルでの動作を保証するため、SVGを直接定義しています
        const Icons = {
            BookOpen: ({size=24, className=""}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            CheckCircle: ({size=24, className=""}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            XCircle: ({size=24, className=""}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>,
            Trophy: ({size=24, className=""}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M8 21h8"/><path d="M12 17v4"/><path d="M7 4h10"/><path d="M17 4v6a5 5 0 1 1-10 0V4"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/></svg>,
            ArrowRight: ({size=24, className=""}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
            RefreshCw: ({size=24, className=""}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
            Info: ({size=24, className=""}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
            Zap: ({size=24, className=""}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        };

        /**
         * ==============================================================================
         * セクション 1: UI部 (User Interface)
         * ------------------------------------------------------------------------------
         * ユーザーに見える画面描画を担当します。
         * ロジックは「エンジン部 (useQuizEngine)」から受け取ります。
         * ==============================================================================
         */
        const App = () => {
            // エンジン部からゲームの状態と操作関数を取得
            const {
                gameState,          // 'start', 'playing', 'result'
                currentQ,           // 現在の問題オブジェクト
                questionsTotal,     // 総問題数
                currentIndex,       // 現在のインデックス
                score,              // スコア
                shuffledOptions,    // シャッフル済み選択肢
                isAnswered,         // 回答済みフラグ
                selectedOptionIndex,// 選択した選択肢のインデックス
                
                startGame,          // ゲーム開始関数
                handleAnswer,       // 回答処理関数
                nextQuestion,       // 次の問題へ
                resetGame           // リセット
            } = useQuizEngine();

            // --- 1-A. スタート画面 ---
            if (gameState === 'start') {
                return (
                    <div className="min-h-screen text-white flex flex-col items-center justify-center p-4">
                        <div className="bg-white/10 backdrop-blur-md p-10 rounded-2xl shadow-2xl border border-white/20 max-w-lg w-full text-center">
                            <div className="mb-6 flex justify-center">
                                <Icons.BookOpen size={64} className="text-yellow-400" />
                            </div>
                            <h1 className="text-4xl font-bold mb-2">FOMC Quiz</h1>
                            <p className="text-yellow-400 font-bold mb-4 tracking-widest">TEST EDITION</p>
                            <p className="text-gray-300 mb-8">
                                データベース登録数: {vocabularyDB.length}語<br/>
                                <span className="text-xs">※1単語につき4パターンの問題を自動生成</span>
                            </p>
                            
                            <div className="space-y-3">
                                <button onClick={() => startGame(5)} className="w-full bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-4 px-6 rounded-xl transition-all shadow-lg flex justify-between items-center transform hover:scale-105">
                                    <span>テスト開始 (5問)</span> <Icons.Zap size={20}/>
                                </button>
                                <button onClick={() => startGame(20)} className="w-full bg-white/10 hover:bg-white/20 text-white font-bold py-3 px-6 rounded-xl transition-all border border-white/10 flex justify-between items-center">
                                    <span>全パターン出題 ({vocabularyDB.length * 4}問)</span> <Icons.ArrowRight size={20}/>
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- 1-B. 結果画面 ---
            if (gameState === 'result') {
                const percentage = Math.round((score / questionsTotal) * 100);
                return (
                    <div className="min-h-screen text-white flex flex-col items-center justify-center p-4">
                        <div className="bg-white/10 backdrop-blur-md p-8 rounded-2xl shadow-2xl border border-white/20 max-w-lg w-full text-center">
                            <Icons.Trophy size={48} className="mx-auto text-yellow-400 mb-4" />
                            <h2 className="text-3xl font-bold mb-2">Test Complete</h2>
                            <div className="text-6xl font-black text-yellow-400 mb-2">{score} <span className="text-2xl text-white font-normal">/ {questionsTotal}</span></div>
                            <p className="text-xl text-gray-200 mb-8">{percentage}% Accuracy</p>
                            
                            <button 
                                onClick={resetGame}
                                className="w-full bg-white text-[#696969] font-bold py-3 px-8 rounded-full hover:bg-gray-200 transition-colors flex items-center justify-center gap-2"
                            >
                                <Icons.RefreshCw size={20} /> Back to Menu
                            </button>
                        </div>
                    </div>
                );
            }

            // --- 1-C. プレイ画面 ---
            const progress = ((currentIndex + 1) / questionsTotal) * 100;

            return (
                <div className="min-h-screen text-white flex flex-col items-center justify-center p-4">
                    {/* プログレスバー */}
                    <div className="fixed top-0 left-0 w-full h-2 bg-black/20">
                        <div 
                            className="h-full bg-yellow-400 transition-all duration-300 ease-out"
                            style={{ width: `${progress}%` }}
                        />
                    </div>

                    <div className="bg-white/10 backdrop-blur-md p-6 md:p-8 rounded-2xl shadow-2xl border border-white/20 max-w-lg w-full relative overflow-hidden min-h-[450px] flex flex-col">
                        
                        {/* ヘッダー情報 */}
                        <div className="flex justify-between items-center mb-6 text-sm text-gray-300 font-mono">
                            <span className="flex items-center gap-2 bg-black/20 px-2 py-1 rounded">
                                Q {currentIndex + 1}/{questionsTotal}
                                <span className="text-xs text-gray-400 px-1 border-l border-gray-600">{currentQ.type}</span>
                            </span>
                            <span className="bg-yellow-500/20 text-yellow-200 px-3 py-1 rounded-full border border-yellow-500/30">Score: {score}</span>
                        </div>

                        {/* 問題文表示エリア */}
                        <div className="mb-6 flex-grow flex flex-col justify-center">
                            <h2 className="text-2xl font-bold text-white mb-4 drop-shadow-md text-center leading-snug whitespace-pre-wrap">
                                {currentQ.question}
                            </h2>
                        </div>

                        {/* 選択肢ボタンエリア */}
                        <div className="space-y-3 mb-4">
                            {shuffledOptions.map((option, idx) => {
                                let btnClass = "w-full text-left p-4 rounded-xl border transition-all duration-200 relative overflow-hidden ";
                                
                                if (!isAnswered) {
                                    btnClass += "bg-white/5 hover:bg-white/20 border-white/10 hover:border-yellow-400/50 cursor-pointer active:scale-95";
                                } else {
                                    if (option.isCorrect) {
                                        btnClass += "bg-green-600/40 border-green-400 text-green-100";
                                    } else if (selectedOptionIndex === idx && !option.isCorrect) {
                                        btnClass += "bg-red-600/40 border-red-400 text-red-100 opacity-60";
                                    } else {
                                        btnClass += "bg-black/10 border-transparent opacity-30";
                                    }
                                }

                                return (
                                    <button
                                        key={idx}
                                        onClick={() => handleAnswer(idx, option.isCorrect)}
                                        disabled={isAnswered}
                                        className={btnClass}
                                    >
                                        <div className="flex justify-between items-center relative z-10">
                                            <span className="font-bold text-lg">{option.text}</span>
                                            {isAnswered && option.isCorrect && <Icons.CheckCircle size={24} className="text-green-400" />}
                                            {isAnswered && selectedOptionIndex === idx && !option.isCorrect && <Icons.XCircle size={24} className="text-red-400" />}
                                        </div>
                                    </button>
                                );
                            })}
                        </div>

                        {/* 解説パネル (回答後に表示) */}
                        {isAnswered && (
                            <div className="bg-black/40 rounded-xl p-4 border border-white/10 animate-[fadeIn_0.3s_ease-out]">
                                <div className="flex items-start gap-3">
                                    <Icons.Info className="text-yellow-400 flex-shrink-0 mt-1" size={20} />
                                    <div className="flex-grow">
                                        <p className="font-bold text-white text-sm mb-1">{currentQ.correct}</p>
                                        <p className="text-sm text-gray-300 leading-relaxed">
                                            {currentQ.explanation}
                                        </p>
                                        <div className="mt-2 pt-2 border-t border-white/10 text-xs text-gray-400 font-serif italic">
                                            Context: "{currentQ.context}"
                                        </div>
                                    </div>
                                </div>
                                
                                <button 
                                    onClick={nextQuestion}
                                    className="mt-3 w-full bg-white text-[#696969] font-bold py-3 rounded-lg hover:bg-gray-200 transition-colors flex items-center justify-center gap-2"
                                >
                                    Next <Icons.ArrowRight size={18} />
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        /**
         * ==============================================================================
         * セクション 2: エンジン部 (Game Engine)
         * ------------------------------------------------------------------------------
         * ゲームロジック、問題生成、ステート管理を行うカスタムフック。
         * 1つの単語データから4パターンの問題を生成するエンジンを含みます。
         * ==============================================================================
         */
        const useQuizEngine = () => {
            const [gameState, setGameState] = useState('start');
            const [questions, setQuestions] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [score, setScore] = useState(0);
            
            // UI用の一時ステート
            const [shuffledOptions, setShuffledOptions] = useState([]);
            const [isAnswered, setIsAnswered] = useState(false);
            const [selectedOptionIndex, setSelectedOptionIndex] = useState(null);

            // --- 2-A. 問題生成エンジン ---
            const getDistractors = (currentWord, type, count = 1) => {
                // 同じタイプの単語から誤答を探す
                let pool = vocabularyDB.filter(item => item.id !== currentWord.id && item.type === type);
                // 足りなければ全体から探す (DBが小さいテスト時はこちらが頻繁に使われます)
                if (pool.length < count) {
                    pool = vocabularyDB.filter(item => item.id !== currentWord.id);
                }
                // ランダムに抽出
                return pool.sort(() => 0.5 - Math.random()).slice(0, count);
            };

            const generateQuestions = () => {
                let allQuestions = [];
                let qId = 1;

                vocabularyDB.forEach(item => {
                    // テスト用にDBが小さいため、誤答候補は1つだけ取得して2択にします
                    const distractors = getDistractors(item, item.type, 1);
                    const wrongAnswer = distractors[0] ? distractors[0] : { japanese: "誤答データ不足", word: "Error" };

                    // パターン1: 英単語 -> 日本語
                    allQuestions.push({
                        qId: qId++,
                        type: 'Word -> JP',
                        question: `What is the meaning of "${item.word}"?`,
                        correct: item.japanese,
                        wrong: wrongAnswer.japanese,
                        explanation: `"${item.word}" means ${item.japanese}.`,
                        context: item.context
                    });

                    // パターン2: 日本語 -> 英単語
                    allQuestions.push({
                        qId: qId++,
                        type: 'JP -> Word',
                        question: `「${item.japanese}」にあたる英単語は？`,
                        correct: item.word,
                        wrong: wrongAnswer.word,
                        explanation: `The English term for "${item.japanese}" is "${item.word}".`,
                        context: item.context
                    });

                    // パターン3: 定義 -> 英単語
                    allQuestions.push({
                        qId: qId++,
                        type: 'Def -> Word',
                        question: `Definition:\n"${item.definition}"`,
                        correct: item.word,
                        wrong: wrongAnswer.word,
                        explanation: `This definition describes "${item.word}".`,
                        context: item.context
                    });

                    // パターン4: 穴埋め (Context)
                    const blankContext = item.context.replace(item.word, "_______").replace(item.word.toLowerCase(), "_______");
                    allQuestions.push({
                        qId: qId++,
                        type: 'Context',
                        question: `Fill in the blank:\n"${blankContext}"`,
                        correct: item.word,
                        wrong: wrongAnswer.word,
                        explanation: `The correct word fits the context.`,
                        context: item.context
                    });
                });

                return allQuestions.sort(() => 0.5 - Math.random());
            };

            // --- 2-B. 操作関数 ---
            const startGame = (count) => {
                const fullSet = generateQuestions();
                // 指定された問題数でスライス（最大値は生成された全問題数）
                const slicedSet = fullSet.slice(0, Math.min(count, fullSet.length));
                setQuestions(slicedSet);
                setScore(0);
                setCurrentIndex(0);
                setGameState('playing');
            };

            // 問題切り替え時の選択肢シャッフル
            useEffect(() => {
                if (gameState === 'playing' && questions[currentIndex]) {
                    const currentQ = questions[currentIndex];
                    const options = [
                        { text: currentQ.correct, isCorrect: true },
                        { text: currentQ.wrong, isCorrect: false }
                    ].sort(() => 0.5 - Math.random());
                    
                    setShuffledOptions(options);
                    setIsAnswered(false);
                    setSelectedOptionIndex(null);
                }
            }, [currentIndex, gameState, questions]);

            const handleAnswer = (index, isCorrect) => {
                if (isAnswered) return;
                setIsAnswered(true);
                setSelectedOptionIndex(index);
                if (isCorrect) setScore(prev => prev + 1);
            };

            const nextQuestion = () => {
                if (currentIndex < questions.length - 1) {
                    setCurrentIndex(prev => prev + 1);
                } else {
                    setGameState('result');
                }
            };

            const resetGame = () => setGameState('start');

            return {
                gameState, currentQ: questions[currentIndex], questionsTotal: questions.length,
                currentIndex, score, shuffledOptions, isAnswered, selectedOptionIndex,
                startGame, handleAnswer, nextQuestion, resetGame
            };
        };

        /**
         * ==============================================================================
         * セクション 3: 単語データベース (Data)
         * ------------------------------------------------------------------------------
         * テスト用に5単語のみ抽出しています。
         * ここに追加することで問題のバリエーションが増えます。
         * ==============================================================================
         */
        const vocabularyDB = [
            {
                id: 1,
                word: "Monetary policy",
                japanese: "金融政策",
                definition: "Actions undertaken by a central bank to influence money availability and cost.",
                context: "The term 'monetary policy' refers to the actions undertaken by a central bank.",
                type: "Concept"
            },
            {
                id: 2,
                word: "Federal Open Market Committee",
                japanese: "連邦公開市場委員会 (FOMC)",
                definition: "The body responsible for open market operations in the Federal Reserve System.",
                context: "The Federal Open Market Committee is responsible for open market operations.",
                type: "Entity"
            },
            {
                id: 3,
                word: "Discount rate",
                japanese: "公定歩合（連銀貸出金利）",
                definition: "The interest rate charged to commercial banks and other depository institutions for loans received from the Federal Reserve.",
                context: "The Board of Governors is responsible for the discount rate.",
                type: "Tool"
            },
            {
                id: 4,
                word: "Federal funds rate",
                japanese: "フェデラル・ファンド金利 (FF金利)",
                definition: "The interest rate at which depository institutions lend balances to each other overnight.",
                context: "Alters the federal funds rate.",
                type: "Concept"
            },
            {
                id: 5,
                word: "Price stability",
                japanese: "物価の安定",
                definition: "A state where the price level does not change, or changes very slowly.",
                context: "Long-run goals of price stability and sustainable economic growth.",
                type: "Goal"
            }
        ];

        // --- レンダリング実行 ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
