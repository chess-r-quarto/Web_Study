<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vocab.app - Lichess Style</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0"
      }
    }
  </script>
  <script>
    Babel.registerPreset('tsx', {
      presets: [
        [Babel.availablePresets['typescript'], { isTSX: true, allExtensions: true }],
        Babel.availablePresets['react']
      ]
    });
  </script>
  <style>
    body {
      background-color: #161512;
      color: #dbd9d6;
      font-family: 'Noto Sans', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }
    ::selection {
      background-color: #1b78d0;
      color: #ffffff;
    }
    textarea {
      scrollbar-color: #383634 #161512;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-type="module" data-presets="tsx">
    import React, { useState, useEffect, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      Check, X, RefreshCw, Settings, BookOpen, 
      Clipboard, Play, UploadCloud, FileJson, RotateCcw, 
      Minimize, Maximize, Hash, Shuffle, ListOrdered 
    } from 'lucide-react';

    interface QuestionData {
      id: number;
      word: string;
      meaning: string;
      wrong: string;
      context: string;
      source: string;
    }

    interface Choice {
      text: string;
      isCorrect: boolean;
    }

    type QuestionCountOption = '50' | '100' | 'all';

    const DEFAULT_DATA: QuestionData[] = [
      { id: 1, word: "unprecedented", meaning: "前例のない", wrong: "予測可能な", context: "The court made an unprecedented ruling.", source: "BBC News" },
      { id: 2, word: "ratify", meaning: "批准する", wrong: "棄却する", context: "Parliament is expected to ratify the agreement.", source: "Global Politics" },
      { id: 3, word: "plaintiff", meaning: "原告", wrong: "被告", context: "The plaintiff argued that the contract was breached.", source: "Legal Daily" },
      { id: 4, word: "mitigate", meaning: "軽減する", wrong: "悪化させる", context: "Measures were taken to mitigate the impact.", source: "Science Today" },
      { id: 5, word: "sovereignty", meaning: "主権", wrong: "従属性", context: "Respect for national sovereignty is a core principle.", source: "UN Charter" }
    ];

    const WindowControls = ({ onReset, onExitFS, onEnterFS }: { onReset: () => void, onExitFS: () => void, onEnterFS: () => void }) => (
      <div className="flex gap-3 text-[#8c8c8c]">
        <button onClick={onReset} className="hover:text-white transition-colors" title="Reset App"><RotateCcw size={16} /></button>
        <button onClick={onExitFS} className="hover:text-white transition-colors" title="Exit Fullscreen"><Minimize size={16} /></button>
        <button onClick={onEnterFS} className="hover:text-white transition-colors" title="Enter Fullscreen"><Maximize size={16} /></button>
      </div>
    );

    interface AppContainerProps {
      children: React.ReactNode;
      title?: string;
      className?: string;
      onReset: () => void;
      onExitFS: () => void;
      onEnterFS: () => void;
    }

    const AppContainer = ({ children, title = "Vocab.app", className = "", onReset, onExitFS, onEnterFS }: AppContainerProps) => (
      <div className={`w-full max-w-3xl mx-auto flex flex-col bg-[#262421] shadow-xl rounded-sm overflow-hidden border border-[#383634] ${className}`}>
        <div className="h-12 bg-[#1b1a19] border-b border-[#383634] flex items-center justify-between px-4 shrink-0">
          <div className="font-bold text-[#dbd9d6] flex items-center gap-2">
            <BookOpen size={18} className="text-[#8c8c8c]" />
            {title}
          </div>
          <WindowControls onReset={onReset} onExitFS={onExitFS} onEnterFS={onEnterFS} />
        </div>
        <div className="flex-1 flex flex-col relative bg-[#262421]">
          {children}
        </div>
      </div>
    );

    interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
      variant?: "primary" | "secondary" | "danger" | "ghost";
      icon?: React.ElementType;
    }

    const Button = ({ onClick, children, variant = "primary", className = "", disabled = false, icon: Icon, ...props }: ButtonProps) => {
      const baseStyle = "px-4 py-2 text-sm font-bold uppercase tracking-wide transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed rounded-sm";
      
      const variants = {
        primary: "bg-[#629924] text-white hover:bg-[#72a332] shadow-[0_2px_0_rgba(0,0,0,0.2)] active:translate-y-[2px] active:shadow-none",
        secondary: "bg-[#383634] text-[#dbd9d6] hover:bg-[#454341] shadow-[0_2px_0_rgba(0,0,0,0.2)] active:translate-y-[2px] active:shadow-none",
        danger: "bg-[#cc3333] text-white hover:bg-[#d64040] shadow-[0_2px_0_rgba(0,0,0,0.2)] active:translate-y-[2px] active:shadow-none",
        ghost: "bg-transparent text-[#8c8c8c] hover:bg-[#383634] hover:text-[#dbd9d6]"
      };

      return (
        <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`} {...props}>
          {Icon && <Icon size={16} />}
          {children}
        </button>
      );
    };

    function App() {
      const [gameState, setGameState] = useState<'start' | 'editor' | 'playing' | 'result'>('start'); 
      const [questions, setQuestions] = useState<QuestionData[]>(DEFAULT_DATA);
      const [activeQuestions, setActiveQuestions] = useState<QuestionData[]>([]);
      const [currentIndex, setCurrentIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [showFeedback, setShowFeedback] = useState(false);
      const [lastAnswerCorrect, setLastAnswerCorrect] = useState(false);
      const [shuffledChoices, setShuffledChoices] = useState<Choice[]>([]);
      
      const [questionCount, setQuestionCount] = useState<QuestionCountOption>('all');
      const [isRandomOrder, setIsRandomOrder] = useState<boolean>(false);

      const [jsonInput, setJsonInput] = useState(JSON.stringify(DEFAULT_DATA, null, 2));
      const [jsonError, setJsonError] = useState<string | null>(null);
      const fileInputRef = useRef<HTMLInputElement>(null);

      const currentQuestion = activeQuestions[currentIndex];

      useEffect(() => {
        if (currentQuestion) {
          const choices = [
            { text: currentQuestion.meaning, isCorrect: true },
            { text: currentQuestion.wrong, isCorrect: false }
          ];
          setShuffledChoices(choices.sort(() => Math.random() - 0.5));
        }
      }, [currentQuestion, currentIndex]);

      const startSession = () => {
        let pool = [...questions];
        
        if (isRandomOrder) {
          pool.sort(() => Math.random() - 0.5);
        } else {
          pool.sort((a, b) => a.id - b.id);
        }

        let count = pool.length;
        if (questionCount === '50') count = Math.min(50, pool.length);
        else if (questionCount === '100') count = Math.min(100, pool.length);

        setActiveQuestions(pool.slice(0, count));
        setScore(0);
        setCurrentIndex(0);
        setShowFeedback(false);
        setGameState('playing');
      };

      const handleAnswer = (isCorrect: boolean) => {
        setLastAnswerCorrect(isCorrect);
        if (isCorrect) setScore(s => s + 1);
        setShowFeedback(true);
      };

      const nextQuestion = () => {
        setShowFeedback(false);
        if (currentIndex < activeQuestions.length - 1) {
          setCurrentIndex(i => i + 1);
        } else {
          setGameState('result');
        }
      };

      const returnToStart = () => {
        setGameState('start');
      };

      const handlePasteFromClipboard = async () => {
        try {
          const text = await navigator.clipboard.readText();
          setJsonInput(text);
          setJsonError(null); 
        } catch (err) {
          setJsonError("Clipboard access denied. Please paste manually.");
        }
      };

      const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {
        const file = event.target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          const content = e.target?.result as string;
          try {
            JSON.parse(content); 
            setJsonInput(content);
            setJsonError(null);
          } catch (error: any) {
            setJsonError("Invalid JSON file: " + error.message);
          }
        };
        reader.readAsText(file);
        event.target.value = '';
      };

      const triggerFileUpload = () => {
        fileInputRef.current?.click();
      };

      const handleImport = () => {
        try {
          const parsed = JSON.parse(jsonInput);
          if (!Array.isArray(parsed)) throw new Error("Format Error: Data must be a JSON Array [...]");
          if (parsed.length === 0) throw new Error("Data Error: The array is empty.");
          if (!parsed[0].word || !parsed[0].meaning) throw new Error("Structure Error: Missing 'word' or 'meaning' fields.");
          
          setQuestions(parsed);
          setJsonError(null);
          setGameState('start'); 
        } catch (e: any) {
          setJsonError(e.message);
        }
      };

      const handleFullScreenEnter = () => {
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
          elem.requestFullscreen().catch(err => console.log(err));
        }
      };

      const handleFullScreenExit = () => {
        if (document.exitFullscreen && document.fullscreenElement) {
          document.exitFullscreen().catch(err => console.log(err));
        }
      };

      const handleAppReset = () => {
        returnToStart();
      };

      const BaseWrapper = ({ children, title, className }: { children: React.ReactNode, title?: string, className?: string }) => (
        <AppContainer 
          title={title} 
          className={className}
          onReset={handleAppReset}
          onEnterFS={handleFullScreenEnter}
          onExitFS={handleFullScreenExit}
        >
          {children}
        </AppContainer>
      );

      if (gameState === 'start') {
        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <BaseWrapper className="h-[550px]">
              <div className="flex-1 flex flex-col items-center justify-center p-8 space-y-8">
                <div className="text-center space-y-2">
                  <h1 className="text-4xl font-bold tracking-wider text-[#dbd9d6]">VOCABULARY</h1>
                  <p className="text-[#8c8c8c] text-sm">{questions.length} words loaded in database</p>
                </div>

                <div className="w-full max-w-sm space-y-6 pt-4">
                  <div className="space-y-4 bg-[#1b1a19] p-4 rounded-sm border border-[#383634]">
                    <div className="space-y-2">
                      <div className="flex items-center gap-2 text-xs font-bold text-[#8c8c8c] uppercase">
                        <Hash size={14} /> Questions
                      </div>
                      <div className="flex gap-1 bg-[#262421] p-1 rounded-sm border border-[#383634]">
                        {(['50', '100', 'all'] as const).map(v => (
                          <button
                            key={v}
                            onClick={() => setQuestionCount(v)}
                            className={`flex-1 py-1.5 text-xs font-bold uppercase rounded-sm transition-colors ${questionCount === v ? 'bg-[#383634] text-white shadow-sm' : 'text-[#8c8c8c] hover:text-[#dbd9d6]'}`}
                          >
                            {v}
                          </button>
                        ))}
                      </div>
                    </div>

                    <div className="space-y-2">
                      <div className="flex items-center gap-2 text-xs font-bold text-[#8c8c8c] uppercase">
                        <ListOrdered size={14} /> Order
                      </div>
                      <div className="flex gap-1 bg-[#262421] p-1 rounded-sm border border-[#383634]">
                        <button
                          onClick={() => setIsRandomOrder(false)}
                          className={`flex-1 py-1.5 text-xs font-bold uppercase rounded-sm flex items-center justify-center gap-2 transition-colors ${!isRandomOrder ? 'bg-[#383634] text-white shadow-sm' : 'text-[#8c8c8c] hover:text-[#dbd9d6]'}`}
                        >
                          <ListOrdered size={14} /> ID Order
                        </button>
                        <button
                          onClick={() => setIsRandomOrder(true)}
                          className={`flex-1 py-1.5 text-xs font-bold uppercase rounded-sm flex items-center justify-center gap-2 transition-colors ${isRandomOrder ? 'bg-[#383634] text-white shadow-sm' : 'text-[#8c8c8c] hover:text-[#dbd9d6]'}`}
                        >
                          <Shuffle size={14} /> Random
                        </button>
                      </div>
                    </div>
                  </div>

                  <div className="space-y-3">
                    <Button onClick={startSession} className="w-full py-4 text-lg" icon={Play}>
                      Play
                    </Button>
                    <Button variant="secondary" onClick={() => setGameState('editor')} className="w-full py-3" icon={Settings}>
                      Import JSON
                    </Button>
                  </div>
                </div>
              </div>
            </BaseWrapper>
          </div>
        );
      }

      if (gameState === 'editor') {
        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <BaseWrapper title="Import Data" className="h-[600px]">
              <div className="flex flex-col h-full">
                <input 
                  type="file" 
                  accept=".json" 
                  ref={fileInputRef} 
                  onChange={handleFileSelect} 
                  className="hidden" 
                />

                <div className="bg-[#1b1a19] border-b border-[#383634] p-2 flex justify-between items-center">
                   <div className="flex gap-2">
                     <Button variant="ghost" onClick={triggerFileUpload} className="h-8 text-xs" icon={UploadCloud}>
                       Load File
                     </Button>
                     <Button variant="ghost" onClick={handlePasteFromClipboard} className="h-8 text-xs" icon={Clipboard}>
                       Paste
                     </Button>
                   </div>
                   <Button variant="ghost" onClick={returnToStart} className="h-8 text-xs">Cancel</Button>
                </div>
                
                <div className="flex-1 relative">
                  <textarea
                    className="w-full h-full p-4 font-mono text-sm bg-[#161512] text-[#85A94E] resize-none focus:outline-none placeholder:text-[#383634]"
                    value={jsonInput}
                    onChange={(e) => setJsonInput(e.target.value)}
                    spellCheck={false}
                    placeholder="Paste JSON..."
                  />
                </div>

                <div className="bg-[#1b1a19] p-4 border-t border-[#383634] flex justify-between items-center">
                  <div className="flex-1 pr-4">
                    {jsonError ? (
                      <span className="text-[#cc3333] text-sm font-bold flex items-center gap-2">
                        <X size={16} /> {jsonError}
                      </span>
                    ) : (
                      <span className="text-[#8c8c8c] text-sm font-bold flex items-center gap-2">
                        <FileJson size={16} /> JSON Valid
                      </span>
                    )}
                  </div>
                  <Button onClick={handleImport} icon={Check}>
                    Save Data
                  </Button>
                </div>
              </div>
            </BaseWrapper>
          </div>
        );
      }

      if (gameState === 'result') {
        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <BaseWrapper title="Session Complete" className="h-[450px]">
              <div className="flex-1 flex flex-col items-center justify-center p-8 space-y-8 text-center">
                <div className="space-y-2">
                  <h2 className="text-2xl font-bold text-[#8c8c8c] uppercase tracking-widest">Accuracy</h2>
                  <div className="text-6xl font-bold text-[#dbd9d6]">
                    {Math.round((score / activeQuestions.length) * 100)}%
                  </div>
                </div>

                <div className="bg-[#1b1a19] border border-[#383634] px-8 py-4 rounded-sm">
                  <p className="text-lg text-[#dbd9d6]">
                    <span className="text-[#629924] font-bold">{score}</span> correct out of <span className="font-bold">{activeQuestions.length}</span>
                  </p>
                </div>

                <div className="pt-8 w-full max-w-xs">
                  <Button onClick={returnToStart} className="w-full py-4" icon={RefreshCw}>
                    Return to Start
                  </Button>
                </div>
              </div>
            </BaseWrapper>
          </div>
        );
      }

      return (
        <div className="min-h-screen flex items-center justify-center p-4">
          <BaseWrapper title={`Question ${currentIndex + 1} / ${activeQuestions.length}`} className="h-[550px]">
            <div className="h-1 w-full bg-[#1b1a19]">
              <div 
                className="h-full bg-[#1b78d0] transition-all duration-300"
                style={{ width: `${((currentIndex) / activeQuestions.length) * 100}%` }}
              />
            </div>

            <div className="flex-1 flex flex-col">
              <div className="flex-1 flex flex-col items-center justify-center p-8 relative">
                <div className="absolute top-4 right-6 text-xs font-bold text-[#8c8c8c] uppercase flex flex-col items-end gap-1">
                  <span>ID: {currentQuestion.id}</span>
                  <span>{currentQuestion.source}</span>
                </div>
                
                <h2 className="text-4xl md:text-6xl font-bold text-white tracking-tight text-center">
                  {currentQuestion.word}
                </h2>
              </div>

              <div className="h-64 bg-[#1b1a19] border-t border-[#383634] relative">
                {!showFeedback ? (
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 p-6 h-full">
                    {shuffledChoices.map((choice, idx) => (
                      <button
                        key={idx}
                        onClick={() => handleAnswer(choice.isCorrect)}
                        className="bg-[#262421] border border-[#383634] hover:bg-[#383634] hover:border-[#8c8c8c] text-xl font-bold text-[#dbd9d6] rounded-sm transition-colors active:bg-[#454341] flex items-center justify-center"
                      >
                        {choice.text}
                      </button>
                    ))}
                  </div>
                ) : (
                  <div className="absolute inset-0 flex flex-col p-6 animate-in fade-in duration-200">
                    <div className="flex-1 flex flex-col justify-center items-center text-center space-y-4">
                      <div className={`text-2xl font-bold flex items-center gap-2 ${lastAnswerCorrect ? 'text-[#629924]' : 'text-[#cc3333]'}`}>
                        {lastAnswerCorrect ? <Check size={32} /> : <X size={32} />}
                        {lastAnswerCorrect ? 'Correct' : 'Inaccuracy'}
                      </div>
                      
                      <div className="text-xl">
                        <span className="text-[#8c8c8c]">Meaning: </span>
                        <span className="text-white font-bold">{currentQuestion.meaning}</span>
                      </div>

                      {currentQuestion.context && (
                        <div className="text-[#dbd9d6] italic max-w-lg mt-4 px-4 border-l-4 border-[#383634]">
                          {currentQuestion.context}
                        </div>
                      )}
                    </div>
                    
                    <div className="mt-auto">
                      <Button onClick={nextQuestion} className="w-full py-4 text-lg">
                        Next
                      </Button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </BaseWrapper>
        </div>
      );
    }

    const root = createRoot(document.getElementById('root')!);
    root.render(<App />);
  </script>
</body>
</html>
